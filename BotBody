from extensions import APIException, CryptoConverter
import telebot
from Token import bot_token, keys

# https://t.me/Merkalyutbot –±–æ—Ç –≤ —Ç–≥


bot = telebot.TeleBot(bot_token)


@bot.message_handler(commands=['start', 'help'])
def start(message: telebot.types.Message):
    text = '–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É –≤ —Å–ª–µ–¥—É—é—â–∏–º —Ñ–æ—Ä–º–∞—Ç–µ (–±–æ—Ç—É –ø–∏—Å–∞—Ç—å –æ–¥–Ω–æ–π ' \
        '—Å—Ç—Ä–æ–∫–æ–π):\n\n' \
        '<–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã> (–° –º–∞–ª–µ–Ω—å–∫–æ–π –±—É–∫–≤—ã!)\n' \
        '<–í –∫–∞–∫—É—é –≤–∞–ª—é—Ç—É –ø–µ—Ä–µ–≤–µ—Å—Ç–∏>\n' \
        '<–ö–æ–ª-–≤–æ –ø–µ—Ä–µ–≤–æ–¥–∏–º–æ–π –≤–∞–ª—é—Ç—ã\n\n' \
        '–£–∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ –µ—Å—Ç—å –≤–∞–ª—é—Ç—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞:\n' \
        'üíµ/valuesüíµ'
    bot.reply_to(message, text)


@bot.message_handler(commands=['values'])
def values(message: telebot.types.Message):
    text = '–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞–ª—é—Ç—ã:\n\n'
    for key in keys:
        text = '\n'.join((text, key)) + 'üí∏'
    bot.reply_to(message, text)


@bot.message_handler(content_types=['text'])
def calculate(message: telebot.types.Message):
    try:
        value = message.text.split()

        if len(value) != 3:
            raise APIException('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤')

        quote, base, amount = value

        total_base = CryptoConverter.get_price(quote, base, amount)
    except APIException as e:
        bot.reply_to(message, f'–û—à–∏–±–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n{e}')
    except Exception as e:
        bot.send_message(message.chat.id, f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–º–∞–Ω–¥—É\n{e}")
    else:
        text = f'–¶–µ–Ω–∞ {amount} {quote} –≤ {base} —Ä–∞–≤–Ω–∞: {total_base}'
        bot.send_message(message.chat.id, text)


bot.polling(none_stop=True)
