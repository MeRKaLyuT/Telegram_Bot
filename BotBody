import json
import requests
import telebot
from Token import bot_token


bot = telebot.TeleBot(bot_token)

keys = {
    '–¥–æ–ª–ª–∞—Ä': 'USD',
    '–µ–≤—Ä–æ': 'EUR',
    '—Ä—É–±–ª—å': 'RUB'
}


class APIException(Exception):
    pass


class CryptoConverter:
    @staticmethod
    def convert(self, quote: str, base: str, amount: str):

        if quote == base:
            raise APIException(f'–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –≤–∞–ª—é—Ç—ã {base}')

        try:
            quote_ticker = keys[quote]
        except KeyError:
            raise APIException(f'–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞–ª—é—Ç—É {quote}')

        try:
            base_ticker = keys[base]
        except KeyError:
            raise APIException(f'–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞–ª—é—Ç—É {base}')

        try:
            amount = float(amount)
        except ValueError:
            raise APIException(f'–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–ª-–≤–æ {amount}')

        r = requests.get(f'https://v6.exchangerate-api.com/v6/0f7d02e333fc3568f1abfa80/latest/{keys[quote]}')
        data = json.loads(r.content)
        money = data['conversion_rates'][keys[base]] * float(amount)
        return money


@bot.message_handler(commands=['start', 'help'])
def start(message: telebot.types.Message):
    text = '–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É –≤ —Å–ª–µ–¥—É—é—â–∏–º —Ñ–æ—Ä–º–∞—Ç–µ (–±–æ—Ç—É –ø–∏—Å–∞—Ç—å –æ–¥–Ω–æ–π ' \
        '—Å—Ç—Ä–æ–∫–æ–π):\n\n' \
        '<–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã> (–° –º–∞–ª–µ–Ω—å–∫–æ–π –±—É–∫–≤—ã!)\n' \
        '<–í –∫–∞–∫—É—é –≤–∞–ª—é—Ç—É –ø–µ—Ä–µ–≤–µ—Å—Ç–∏>\n' \
        '<–ö–æ–ª-–≤–æ –ø–µ—Ä–µ–≤–æ–¥–∏–º–æ–π –≤–∞–ª—é—Ç—ã\n\n' \
        '–£–∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ –µ—Å—Ç—å –≤–∞–ª—é—Ç—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞:\n' \
        'üíµ/valuesüíµ'
    bot.reply_to(message, text)


@bot.message_handler(commands=['values'])
def values(message: telebot.types.Message):
    text = '–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞–ª—é—Ç—ã:\n\n'
    for key in keys:
        text = '\n'.join((text, key)) + 'üí∏'
    bot.reply_to(message, text)


@bot.message_handler(content_types=['text'])
def calculate(message: telebot.types.Message):
    value = message.text.split()

    if len(value) != 3:
        bot.reply_to(message, "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤")
        raise APIException('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤')

    quote, base, amount = value

    total_base = CryptoConverter.convert(quote, base, amount)

    text = f'–¶–µ–Ω–∞ {amount} {quote} –≤ {base} —Ä–∞–≤–Ω–∞: {total_base}'
    bot.send_message(message.chat.id, text)


bot.polling(none_stop=True)
